---
- name: Configure Duke MCP bastion/login node
  hosts: login_nodes
  become: yes
  vars:
    mcp_user: mcp
    mcp_home: /home/{{ mcp_user }}
    mcp_venv: "{{ mcp_home }}/venv"
    mcp_repo: https://github.com/duke/duke-mcp.git
    mcp_branch: main
    systemd_service_name: duke-mcp-local
  
  tasks:
    - name: Install system dependencies
      apt:
        name:
          - python3.10
          - python3.10-venv
          - python3-pip
          - git
          - build-essential
          - libssl-dev
          - libffi-dev
          - curl
          - jq
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"
    
    - name: Install system dependencies (RHEL)
      yum:
        name:
          - python3
          - python3-devel
          - git
          - gcc
          - openssl-devel
          - libffi-devel
          - curl
          - jq
        state: present
      when: ansible_os_family == "RedHat"
    
    - name: Create MCP service user
      user:
        name: "{{ mcp_user }}"
        comment: "Duke MCP Service Account"
        shell: /bin/bash
        create_home: yes
        home: "{{ mcp_home }}"
    
    - name: Create required directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ mcp_user }}"
        group: "{{ mcp_user }}"
        mode: '0755'
      loop:
        - "{{ mcp_home }}/logs"
        - "{{ mcp_home }}/suggested_jobs"
        - "{{ mcp_home }}/config"
    
    - name: Clone MCP repository
      git:
        repo: "{{ mcp_repo }}"
        dest: "{{ mcp_home }}/duke-mcp"
        version: "{{ mcp_branch }}"
        force: yes
      become_user: "{{ mcp_user }}"
    
    - name: Create Python virtual environment
      command: python3.10 -m venv {{ mcp_venv }}
      args:
        creates: "{{ mcp_venv }}/bin/activate"
      become_user: "{{ mcp_user }}"
    
    - name: Upgrade pip in venv
      pip:
        name: pip
        state: latest
        virtualenv: "{{ mcp_venv }}"
      become_user: "{{ mcp_user }}"
    
    - name: Install Python dependencies
      pip:
        requirements: "{{ mcp_home }}/duke-mcp/mcp/server/requirements.txt"
        virtualenv: "{{ mcp_venv }}"
      become_user: "{{ mcp_user }}"
    
    - name: Create systemd service file
      template:
        src: templates/duke-mcp-local.service.j2
        dest: /etc/systemd/system/{{ systemd_service_name }}.service
        owner: root
        group: root
        mode: '0644'
      notify: reload systemd
    
    - name: Create environment file for service
      template:
        src: templates/mcp-env.j2
        dest: "{{ mcp_home }}/config/mcp.env"
        owner: "{{ mcp_user }}"
        group: "{{ mcp_user }}"
        mode: '0600'
    
    - name: Configure firewall for MCP service
      ufw:
        rule: allow
        port: '8000'
        proto: tcp
        comment: "Duke MCP Service"
      when: ansible_os_family == "Debian"
    
    - name: Configure firewall (RHEL)
      firewalld:
        port: 8000/tcp
        permanent: yes
        state: enabled
        immediate: yes
      when: ansible_os_family == "RedHat"
    
    - name: Enable and start MCP service
      systemd:
        name: "{{ systemd_service_name }}"
        enabled: yes
        state: started
        daemon_reload: yes
    
    - name: Create log rotation configuration
      copy:
        dest: /etc/logrotate.d/duke-mcp
        content: |
          {{ mcp_home }}/logs/*.log {
              daily
              rotate 14
              compress
              delaycompress
              notifempty
              create 0640 {{ mcp_user }} {{ mcp_user }}
              sharedscripts
              postrotate
                  systemctl reload {{ systemd_service_name }} > /dev/null 2>&1 || true
              endscript
          }
        owner: root
        group: root
        mode: '0644'
    
    - name: Setup audit logging
      lineinfile:
        path: /etc/audit/rules.d/duke-mcp.rules
        line: "-w {{ mcp_home }}/suggested_jobs -p wa -k duke_mcp_suggestions"
        create: yes
      notify: restart auditd
    
  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes
    
    - name: restart auditd
      service:
        name: auditd
        state: restarted